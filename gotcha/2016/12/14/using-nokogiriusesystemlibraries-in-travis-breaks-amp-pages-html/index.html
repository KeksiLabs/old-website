<!DOCTYPE html><html class="no-js" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8" lang="en"><title>Using NOKOGIRI_USE_SYSTEM_LIBRARIES in Travis CI breaks amp pages | Keksi.io</title><meta name="description" content="Travis might break your amp pages when you’re using NOKOGIRI_USE_SYSTEM_LIBRARIES: true.
"><meta name="viewport" content="width=device-width, initial-scale=1"><meta property="og:title" content="Using NOKOGIRI_USE_SYSTEM_LIBRARIES in Travis CI breaks amp pages"/><meta property="og:image" content="https://keksi.io/img/keksi-labs-og-small.png"/><meta name="twitter:image:alt" content="Keksi.io logo"/><meta property="og:image:width" content="300"/><meta property="og:image:height" content="300"/><meta name="twitter:site" content="keksiengineer"/><meta name="twitter:creator" content="koodimonni"/><meta property="article:published_time" content="2016-12-14T00:00:00+00:00"><meta property="article:modified_time" content="2016-12-14T22:39:29+00:00"><meta property="article:author" content="monnionni"><meta property="article:section" content="gotcha"><meta property="article:tag" content="travis,jekyll,bug"><meta property="og:type" content="article"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://keksi.io/tech/TravisCI-Full-Color-45e242791b7752b745a7ae53f265acd4.png"/><meta name="twitter:image:alt" content="Travis CI"/><meta property="og:description" content="Travis might break your amp pages when you’re using NOKOGIRI_USE_SYSTEM_LIBRARIES: true.
"/><meta property="og:url" content="https://keksi.io/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html/"/><meta property="og:locale" content="en_US"/><link rel="amphtml" href="https://keksi.io/amp/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html"><link type="text/css" rel="stylesheet" href="/assets/main-72b7720bf5f8884ff8539861c403b9c3bb2875391497ce90242d913ffc31f7ad.css"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="canonical" href="https://keksi.io/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html/"><link rel="alternate" type="application/atom+xml" title="Keksi.io" href="https://keksi.io/feed.xml"/> <script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-88238366-1","auto"),ga("send","pageview")</script></head><body> <header class="site-header"><div class="branding"> <a href="/"> <picture><source type="image/svg+xml" srcset="/logo.svg"><img class="avatar" src="/logo-44x44.png" width="44" alt="Keksi Labs Logo" height="44"></picture><h1 class="site-title">Keksi.io</h1> </a></div> <nav class="site-nav"><ul><li> <a class="page-link" href="/about/"> About </a></li></ul> </nav><nav class="external-links"><ul><li> <a href="https://keksi.io/feed.xml" title="Follow RSS feed"> <i class="fa fa-fw fa-rss"></i> </a></li><li> <a href="mailto:hello@keksi.io" title="Email"> <i class="fa fa-fw fa-envelope"></i> </a></li><li> <a href="https://github.com/KeksiLabs" title="Follow on GitHub"> <i class="fa fa-fw fa-github"></i> </a></li><li> <a href="https://twitter.com/keksiengineer" title="Follow on Twitter"> <i class="fa fa-fw fa-twitter"></i> </a></li></ul> </nav> </header><div class="content"> <article itemscope="itemscope" itemtype="http://schema.org/BlogPosting" itemprop="blogPost"> <header style="background-image:url('/')"><h1 itemprop="headline" class="title">Using NOKOGIRI_USE_SYSTEM_LIBRARIES in Travis CI breaks amp pages</h1><div class="post-about"> <span class="visually-hidden-mobile">Written by</span> <span class="entry-author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><a href="https://keybase.io/onnimonni" title="Posts by Onni Hakala" rel="author" class="url fn n" itemprop="url"> <img itemprop="image" class="img-circle meta-author-image" width="40" height="40" alt="Onni Hakala" src="https://s.gravatar.com/avatar/ffbe81bf9fa424901ddc06be226c98a4"> <span itemprop="name">Onni Hakala</span></a></span> on <time class="entry-published updated" datetime="2016-12-14T00:00:00+0000" itemprop="datePublished" title="Wednesday, December 14, 2016">December 14, 2016</time><span class="visually-hidden-mobile">.</span><p class="description"> <span class="visually-hidden-mobile">This article is</span> about <span itemprop="keywords"> <strong>travis</strong>, <strong>jekyll</strong> and <strong>bug</strong>. </span></p></div> </header><section itemprop="articleBody" class="post-content"><p>Travis might break your <a href="https://www.ampproject.org/">amp pages</a> when you’re using <code class="highlighter-rouge">NOKOGIRI_USE_SYSTEM_LIBRARIES: true</code>.</p><p>Do you know the feeling when you have a bug which is just motherf* hard son of a bitch level bug to track. You spend hours or even days figuring it out persistantly closing different options out of the bigger picture. This just happened to me as well.</p><p><a href="https://search.google.com/search-console/amp">Google AMP validator</a> just outputted multiple errors even though my local development environment was just fine:</p><div class="highlighter-rouge"><pre class="highlight"><code>The tag 'script' is disallowed except in specific forms.
The mandatory tag 'amphtml engine v0.js script' is missing or incorrect. (see
</code></pre></div><h2 id="the-context">The context</h2><p>I’m building and testing this site in <a href="https://travis-ci.org/KeksiLabs/keksi.io">Travis CI</a>. I had enabled <code class="highlighter-rouge">NOKOGIRI_USE_SYSTEM_LIBRARIES: true</code> in my <code class="highlighter-rouge">.travis.yml</code> because many developers have had good experience with that in order to speed up the builds.</p><p>Somehow the older version of nokogiri outputted the closing elements for my html head <code class="highlighter-rouge">&lt;/head&gt;&lt;body&gt;</code> too early.</p><p><strong>This was what I wanted to achieve:</strong></p><div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;noscript&gt;&lt;style </span><span class="na">amp-boilerplate</span><span class="nt">&gt;body</span><span class="p">{</span><span class="nl">-webkit-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">-moz-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">-ms-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">animation</span><span class="p">:</span><span class="nb">none</span><span class="p">}</span><span class="nt">&lt;/style&gt;&lt;/noscript&gt;</span> <span class="nt">&lt;script </span><span class="na">async</span> <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0.js"</span><span class="nt">&gt;&lt;/script&gt;&lt;script </span><span class="na">async</span> <span class="na">custom-element=</span><span class="s">"amp-analytics"</span> <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0/amp-analytics-0.1.js"</span><span class="nt">&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;</span>
</code></pre></div><p><strong>This was what happened in the build phase instead:</strong></p><div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;/head&gt;&lt;body&gt;</span> <span class="nt">&lt;noscript&gt;&lt;style </span><span class="na">amp-boilerplate</span><span class="nt">&gt;body</span><span class="p">{</span><span class="nl">-webkit-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">-moz-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">-ms-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">animation</span><span class="p">:</span><span class="nb">none</span><span class="p">}</span><span class="nt">&lt;/style&gt;&lt;/noscript&gt;</span> <span class="nt">&lt;script </span><span class="na">async</span> <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0.js"</span><span class="nt">&gt;&lt;/script&gt;&lt;script </span><span class="na">async</span> <span class="na">custom-element=</span><span class="s">"amp-analytics"</span> <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0/amp-analytics-0.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div><p>As you can see the head element ends too soon.</p><h2 id="conclusion">Conclusion</h2><p>In the end it was super relieving after I figured this out. If you’re having random html errors try to disable notorius <code class="highlighter-rouge">NOKOGIRI_USE_SYSTEM_LIBRARIES</code>.</p></section><small class="footnotes"> <i class="fa fa-info-circle"></i> <strong>Info:</strong> This post was last updated on: <time class="entry-modified modified" datetime="2016-12-14T22:39:29+0000" itemprop="dateModified" title="Wednesday, December 14, 2016">December 14, 2016</time>. It is published in <span itemprop="articleSection">gotcha</span> category, contains <span itemprop="wordCount">215</span> words and takes about <span>1</span> minutes to read.<meta itemprop="timeRequired" content="P1"/><meta itemprop="image" content="https://keksi.io/tech/TravisCI-Full-Color-45e242791b7752b745a7ae53f265acd4.png"/><meta itemprop="mainEntityOfPage" content="https://keksi.io/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html/"/> <span> It was published by <span itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"> <span itemprop="logo" itemscope itemtype="https://schema.org/ImageObject"><link itemprop="url" href="https://keksi.io/logo.png"/><meta itemprop="width" content="512"><meta itemprop="height" content="512"> </span><meta itemprop="email" content="hello@keksi.io"> <span itemprop="name">Keksi Labs Oy</span>. </span> </span> </small></article><div class="comments"><h2>Comments:</h2> <a class="muut" href="https://muut.com/i/keksi/comments" type="dynamic">keksi</a> <script async src="//cdn.muut.com/1/moot.min.js"></script></div></div> <footer class="site-footer container"><div class="row"><div class="column"><div id="contact" class="footer-content vcard" itemscope itemtype="http://schema.org/Organization"><h1>Contact Us</h1><div><a class="url fn" itemprop="name" href="https://keksi.io/">Keksi Labs Oy</a></div><div><span itemprop="taxID">2734524-4</span></div> <a class="email" itemprop="email" href="mailto:hello@keksi.io">hello@keksi.io</a><div itemprop="address" itemscope itemtype="http://schema.org/PostalAddress" class="adr"> <span itemprop="addressLocality" class="locality">Tampere</span>, <span itemprop="addressCountry" class="country-name">Finland</span></div></div></div><div class="column"><div class="footer-content"><h1>What we do?</h1><p>Keksi is web solutions agency which uses latest open source tools to provide scalable web platforms. We believe in <strong>testing</strong>, <strong>monitoring</strong> and <strong>automation</strong>.</p><p>Because nobody wants to lose their good night's sleep worrying about crashing servers.</p><p></div></div></div><div class="notice"> <small>© Keksi Labs Oy</small>, <small>Disclaimer: We’re using cookies, because cookies are the best! Have one here: <picture><source type="image/svg+xml" srcset="/logo.svg"><img class="avatar" src="/logo-22x22.png" width="22" alt="Keksi Labs Logo" height="22"></picture></small></div> </footer><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "BlogPosting",

    "headline": "Using NOKOGIRI_USE_SYSTEM_LIBRARIES in Travis CI breaks amp pages",
    
    "image":  {
        "@type": "ImageObject",
        "url": "https://keksi.io/tech/TravisCI-Full-Color-45e242791b7752b745a7ae53f265acd4.png",
        "caption": "Travis CI",
        "height": "201",
        "width": "642"
    },
    
    
    "genre": "Continuous Integration",
    
    "keywords": "travis,jekyll,bug",
    "wordcount": "215",
    "publisher": {
        "@type": "Organization",
        "logo": {
            "@type": "ImageObject",
            "url": "https://keksi.io/logo.png",
            "width": "512",
            "height": "512"
        },
        "email": "hello@keksi.io",
        "name": "Keksi Labs Oy",
        "sameAs": [
            "https://twitter.com/keksiengineer",
            "https://github.com/KeksiLabs"
        ]
    },
    "url": "https://keksi.io/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html/",
    "mainEntityOfPage": "https://keksi.io/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html/",
    "datePublished": "2016-12-14",
    "dateCreated": "2016-12-14",
    "dateModified": "2016-12-14",
    "description": "Travis might break your amp pages when you’re using NOKOGIRI_USE_SYSTEM_LIBRARIES: true.
",
    "articleBody": "Travis might break your amp pages when you’re using NOKOGIRI_USE_SYSTEM_LIBRARIES: true.Do you know the feeling when you have a bug which is just motherf* hard son of a bitch level bug to track. You spend hours or even days figuring it out persistantly closing different options out of the bigger picture. This just happened to me as well.Google AMP validator just outputted multiple errors even though my local development environment was just fine:The tag 'script' is disallowed except in specific forms.The mandatory tag 'amphtml engine v0.js script' is missing or incorrect. (seeThe contextI’m building and testing this site in Travis CI. I had enabled NOKOGIRI_USE_SYSTEM_LIBRARIES: true in my .travis.yml because many developers have had good experience with that in order to speed up the builds.Somehow the older version of nokogiri outputted the closing elements for my html head &lt;/head&gt;&lt;body&gt; too early.This was what I wanted to achieve:&lt;noscript&gt;&lt;style amp-boilerplate&gt;body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}&lt;/style&gt;&lt;/noscript&gt; &lt;script async src=\"https://cdn.ampproject.org/v0.js\"&gt;&lt;/script&gt;&lt;script async custom-element=\"amp-analytics\" src=\"https://cdn.ampproject.org/v0/amp-analytics-0.1.js\"&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;This was what happened in the build phase instead:&lt;/head&gt;&lt;body&gt; &lt;noscript&gt;&lt;style amp-boilerplate&gt;body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}&lt;/style&gt;&lt;/noscript&gt; &lt;script async src=\"https://cdn.ampproject.org/v0.js\"&gt;&lt;/script&gt;&lt;script async custom-element=\"amp-analytics\" src=\"https://cdn.ampproject.org/v0/amp-analytics-0.1.js\"&gt;&lt;/script&gt;As you can see the head element ends too soon.ConclusionIn the end it was super relieving after I figured this out. If you’re having random html errors try to disable notorius NOKOGIRI_USE_SYSTEM_LIBRARIES.",
    "author": {
        "@type": "Person",
        "name": "Onni Hakala",
        "url": "https://keybase.io/onnimonni",
        "image": "https://s.gravatar.com/avatar/ffbe81bf9fa424901ddc06be226c98a4",
        
        "sameAs": [
            
            "https://twitter.com/koodimonni",
            
            
            "https://www.facebook.com/monnionni",
            
            
            "https://keybase.io/onnimonni",
            
            "https://github.com/onnimonni"
        ]
        
    }
}
</script><script src="/assets/app-7e9774e4ca12ac9d274eefe9bb5bbcad25026046fbbfaddab8edf3cc83b7968c.js"></script></body></html>