<!doctype html><html amp lang="en" class="amp"><head><meta charset="utf-8"><title>Using NOKOGIRI_USE_SYSTEM_LIBRARIES in Travis CI breaks amp pages</title><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"><meta property="og:title" content="Using NOKOGIRI_USE_SYSTEM_LIBRARIES in Travis CI breaks amp pages"/><meta property="og:image" content="https://keksi.io/img/keksi-labs-og-small.png"/><meta name="twitter:image:alt" content="Keksi.io logo"/><meta property="og:image:width" content="300"/><meta property="og:image:height" content="300"/><meta name="twitter:site" content="keksiengineer"/><meta name="twitter:creator" content="koodimonni"/><meta property="og:type" content="website"/><meta property="og:description" content="Full speed ahead in Web engineering
"/><meta property="og:url" content="https://keksi.io/amp/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html/"/><meta property="og:locale" content="en_US"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="canonical" href="/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html/"><link rel="alternate" type="application/atom+xml" title="Keksi.io" href="https://keksi.io/feed.xml"/><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet"> <style amp-custom>
        
        /*! normalize.css v3.0.2 | MIT License | git.io/normalize */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{font-size:2em;margin:0.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid #c0c0c0;margin:0 2px;padding:0.35em 0.625em 0.75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}.highlight{background:#272822;padding:20px;color:#ffffff}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight .gh{color:#999999}.highlight .sr{color:#f6aa11}.highlight .go{color:#888888}.highlight .gp{color:#555555}.highlight .gu{color:#aaaaaa}.highlight .nb{color:#f6aa11}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .c,.highlight .cd{color:#75715e}.highlight .err{color:#960050}.highlight .gr{color:#960050}.highlight .gt{color:#960050}.highlight .gd{color:#49483e}.highlight .gi{color:#49483e}.highlight .ge{color:#49483e}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .no{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .il{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .m,.highlight .mb,.highlight .mx{color:#ae81ff}.highlight .sc{color:#ae81ff}.highlight .se{color:#ae81ff}.highlight .ss{color:#ae81ff}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .sb{color:#e6db74}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nc{color:#a6e22e}.highlight .nd{color:#a6e22e}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .vc{color:#ffffff}.highlight .nn{color:#ffffff}.highlight .nl{color:#ffffff}.highlight .ni{color:#ffffff}.highlight .bp{color:#ffffff}.highlight .vg{color:#ffffff}.highlight .vi{color:#ffffff}.highlight .nv{color:#ffffff}.highlight .w{color:#ffffff}.highlight .n,.highlight .py,.highlight .nx{color:#ffffff}.highlight .ow{color:#f92672}.highlight .nt{color:#f92672}.highlight .k,.highlight .kv{color:#f92672}.highlight .kn{color:#f92672}.highlight .kp{color:#f92672}.highlight .o{color:#f92672}code.highlighter-rouge{padding:0.2em;margin:0;font-size:85%;background-color:rgba(0,0,0,0.09);border-radius:3px}.container{margin:0 auto;max-width:112rem;padding:0 2rem;position:relative;width:100%}.row{display:flex;flex-direction:column;padding:0;width:100%}.row.row-no-padding{padding:0}.row.row-no-padding>.column{padding:0}.row.row-wrap{flex-wrap:wrap}.row.row-top{align-items:flex-start}.row.row-bottom{align-items:flex-end}.row.row-center{align-items:center}.row.row-stretch{align-items:stretch}.row.row-baseline{align-items:baseline}.row .column{display:block;flex:1;margin-left:0;max-width:100%;width:100%}.row .column.column-offset-10{margin-left:10%}.row .column.column-offset-20{margin-left:20%}.row .column.column-offset-25{margin-left:25%}.row .column.column-offset-33,.row .column.column-offset-34{margin-left:33.3333%}.row .column.column-offset-50{margin-left:50%}.row .column.column-offset-66,.row .column.column-offset-67{margin-left:66.6666%}.row .column.column-offset-75{margin-left:75%}.row .column.column-offset-80{margin-left:80%}.row .column.column-offset-90{margin-left:90%}.row .column.column-10{flex:0 0 10%;max-width:10%}.row .column.column-20{flex:0 0 20%;max-width:20%}.row .column.column-25{flex:0 0 25%;max-width:25%}.row .column.column-33,.row .column.column-34{flex:0 0 33.3333%;max-width:33.3333%}.row .column.column-40{flex:0 0 40%;max-width:40%}.row .column.column-50{flex:0 0 50%;max-width:50%}.row .column.column-60{flex:0 0 60%;max-width:60%}.row .column.column-66,.row .column.column-67{flex:0 0 66.6666%;max-width:66.6666%}.row .column.column-75{flex:0 0 75%;max-width:75%}.row .column.column-80{flex:0 0 80%;max-width:80%}.row .column.column-90{flex:0 0 90%;max-width:90%}.row .column .column-top{align-self:flex-start}.row .column .column-bottom{align-self:flex-end}.row .column .column-center{align-self:center}@media (min-width: 40rem){.row{flex-direction:row;margin-left:-1rem;width:calc(100% + 2.0rem)}.row .column{margin-bottom:inherit;padding:0 1rem}}*{margin:0;padding:0;box-sizing:border-box}figure{margin:0}.gist table tbody tr td{box-sizing:content-box}html{background:#fff}::selection{background:#D4D4D4}::-moz-selection{background:#D4D4D4}body{color:#383838;font-family:"Open Sans",Helvetica,Arial,sans-serif;font-size:1.25em;word-wrap:break-word}h1,h2,h3,h4,h5,h6{font-family:"Open Sans",Helvetica,Arial,sans-serif;line-height:1.3;margin:0.67em 0}h1 a,h2 a,h3 a,h4 a,h5 a,h6 a{color:#383838}@media (min-width: 600px){h1{font-size:2.5em}h2{font-size:2em}h3{font-size:1.5em}h4{font-size:1.15em}}@media (max-width: 599px){.post-content h1{font-size:0.9em}.post-teaser h1{font-size:1.5em}}blockquote{border-left:2px solid;padding:1em 1em}blockquote p:last-child,footer p:last-child{margin-bottom:0}table{table-layout:fixed;width:100%;word-wrap:break-word}@media (max-width: 1100px){table{overflow-x:scroll;display:inline-block}}td,th{padding:0.5em 1em;border:1px solid rgba(0,0,0,0.1);text-align:left}table,dl,blockquote,code,kbd,pre,samp{margin:1em 0}@media (max-width: 500px){pre.highlight{font-size:0.7em;padding:10px;margin-left:-2em;margin-right:-2em}}dt{font-weight:bold}dd{margin-left:2em}p,ol,ul,dl,.math-display{line-height:1.5;margin-bottom:1em}.math-display{display:inline-block;width:100%}li>ul,li>ol{margin-bottom:0;margin-left:1em}ol,ul{list-style-position:inside}hr{border:0;border-top:1px solid rgba(0,0,0,0.1);border-bottom:1px solid #fff;margin:1em 0}a{color:#1ABC9C;text-decoration:none}.nav{list-style:none;margin:0;padding:0}iframe,img,embed,object,video{max-width:100%}img[align=left]{margin-right:3%}img[align=right]{margin-left:3%}.site-header{padding:3% 6%}@media (max-width: 1000px){.site-header{padding:3% 3%}}section.category-archive,section.tag-archive,article,.comments,.feature-image .post-content,.call-out,.posts .post-teaser,.site-footer{padding:5% 20%}@media (max-width: 500px){section.category-archive,section.tag-archive,article,.comments,.feature-image .post-content,.call-out,.posts .post-teaser,.site-footer{padding:7.5% 10%}}@media (max-width: 1000px){section.category-archive,section.tag-archive,article,.comments,.feature-image .post-content,.call-out,.posts .post-teaser,.site-footer{padding:7.5% 12.5%}}article a:hover,.posts .post-teaser p a:hover{text-decoration:underline;color:#117964}.button{border-radius:0.3em;border:1px solid;display:inline-block;margin:1em 0;padding:0.5em 0.75em}a.button:hover,#post-nav a:hover{background:#1ABC9C;border:1px solid #1ABC9C;color:#fff;text-decoration:none}.disabled{opacity:0.7}@media (max-width: 500px){.visually-hidden-mobile{position:absolute;overflow:hidden;clip:rect(0 0 0 0);height:1px;width:1px;margin:-1px;padding:0;border:0}}.hidden{display:none}.img-circle{border-radius:50%}.post-meta .post-category{color:inherit}.post-meta .post-category:hover{color:#F98752}.post-meta{padding-top:10px}.post-meta .tag:before{content:"#"}section.category-archive{border-bottom:1px solid rgba(0,0,0,0.1)}section.category-archive .category-header{text-align:center;padding-top:5em}section.category-archive .archive-name{color:#F98752}section.category-archive .post-teaser{padding:0;border-bottom:none}section.tag-archive{border-bottom:1px solid rgba(0,0,0,0.1)}section.tag-archive .tag-header{text-align:center;padding-top:5em}section.tag-archive .tag-header h1 a{text-color:#1ABC9C}section.tag-archive .post-teaser{padding:0;border-bottom:none}section.tag-archive ul.tags{list-style:none}section.tag-archive ul.tags li{font-size:2em;padding-left:0.3em;display:inline-block}.meta-author-image{vertical-align:middle;margin-right:5px}article,.comments{border-bottom:1px solid rgba(0,0,0,0.1);float:left;width:100%}.amp .post-about{padding-bottom:1em}article .post-meta{padding-top:1em}article .post-meta .description{padding-top:5px}article header{margin-bottom:6%;text-align:center}article .footnotes{color:rgba(0,0,0,0.4)}article .post-content .description{padding-top:5px;padding-bottom:5px}article .post-content .description:before{font-weight:bold;content:"In short: "}article .post-content img{box-shadow:3px 4px 10px 0px #777;width:auto;height:auto;max-width:100%}header h1{margin:0}header .meta{color:rgba(56,56,56,0.5);font-size:0.9em;letter-spacing:0.1em;margin:0;text-transform:uppercase}.feature-image{padding:0%}.feature-image .post-link{color:#fff}.feature-image header{color:#fff;background-size:cover;margin-bottom:0;padding:8% 20%}.feature-image header .meta{color:rgba(255,255,255,0.7)}#post-nav{width:100%;border-bottom:1px solid rgba(0,0,0,0.1);display:flex;float:left}#post-nav a,#post-nav .page-title{display:inline-block}#post-nav .page-title{font-size:1.2em;margin-bottom:1em;width:100%}#post-nav a{padding:2em 3em;border:1px solid rgba(255,255,255,0);text-align:center;width:50%}#post-nav i{vertical-align:middle}.call-out{display:inline-block;width:100%;background-color:#F98752;background-size:cover;font-size:1.2em;text-align:center;color:#FFF}@media screen and (max-width: 900px){.call-out{font-size:.9em}}@media screen and (max-width: 600px){.call-out{font-size:.6em;padding:7.5% 7.5%}}.call-out p:last-child{margin-bottom:0}.posts .post-meta{list-style:none}.posts .post-meta li{display:inline-block;padding-right:10px}.posts .post-meta .fa{padding-right:3px}.posts .post-teaser{width:100%;margin-bottom:0;display:inline-block;background-size:cover;border-bottom:1px solid rgba(0,0,0,0.1)}.posts .excerpt{margin-top:1em}.pagination .button{margin:0 1.5em}.pagination .button i{vertical-align:middle}.pagination{padding:5% 20% 0 20%;text-align:center}.site-header{background:#fff;border-bottom:1px solid rgba(0,0,0,0.1);display:inline-block;float:left;width:100%;font-size:1.1em;display:flex}.site-header a{color:#383838}.site-header .avatar{height:2em;width:2em;float:left;margin-top:-3px;border-radius:0.2em;margin-right:0.5em;-webkit-transition:-webkit-transform 0.8s ease-in-out;transition:transform 0.8s ease-in-out}.site-header .avatar:hover{-webkit-transform:rotate(360deg);transform:rotate(360deg)}.site-header .site-title{float:left;font-weight:bold;font-size:1em;line-height:1.5}@media (min-width: 600px){.site-header{justify-content:space-between}.site-header .branding{flex-grow:3}}@media (max-width: 599px){.site-header{flex-wrap:wrap;justify-content:space-between}.site-header .branding,.site-header .external-links,.site-header .site-nav{padding-top:2.5%;padding-bottom:2.5%}.site-header .branding{order:1;min-width:150px}.site-header .external-links{order:2;min-width:200px}.site-header .site-nav{min-width:300px;order:3}.site-header .site-nav ul li{float:left}.site-header .site-nav,.site-header .external-links,.site-header ul,.site-header li{margin-left:0.4em}}.site-header .site-nav ul,.site-header .external-links ul{margin:0;padding:0;list-style:none;line-height:1.5;text-align:right}.site-header .site-nav li,.site-header .external-links li{display:inline;margin-right:0.4em}@media (max-width: 1100px){.site-header .site-nav ul,.site-header .external-links ul{display:inline-block;width:100%}}.site-footer{display:inline-block;text-align:center;width:100%;color:#858585;font-size:0.9em}.site-footer h1{font-size:2em}.site-footer .column{padding:3.5% 3.5%}.site-footer .footer-content{text-align:left}@media (min-width: 640px){.site-footer .footer-content{display:inline-block}}.site-footer #contact{line-height:1.4em}.site-footer #contact .url{color:inherit;text-decoration:inherit;pointer-events:none;cursor:default}.site-footer #contact a{color:#F98752}.site-footer .notice{padding:2%}.site-footer .notice img{vertical-align:bottom}

    </style><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript> <script async src="https://cdn.ampproject.org/v0.js"></script><script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script></head><body> <header class="site-header"><div class="branding"> <a href="/"> <amp-img class="avatar" src="/img/keksi-labs-logo-small.png" width="44" height="44" layout="fixed" alt="Keksi Labs Logo"/></amp-img><h1 class="site-title">Keksi.io</h1> </a></div> <nav class="site-nav"><ul><li> <a class="page-link" href="/about/"> About </a></li></ul> </nav><nav class="external-links"><ul><li> <a href="mailto:hello@keksi.io" title="Email"> <i class="fa fa-fw fa-envelope"></i> </a></li><li> <a href="https://github.com/KeksiLabs" title="Follow on GitHub"> <i class="fa fa-fw fa-github"></i> </a></li><li> <a href="https://twitter.com/keksiengineer" title="Follow on Twitter"> <i class="fa fa-fw fa-twitter"></i> </a></li></ul> </nav> </header><article><h1 class="post-title">Using NOKOGIRI_USE_SYSTEM_LIBRARIES in Travis CI breaks amp pages</h1><div class="post-about"> <span class="visually-hidden-mobile">Written by</span> <span class="entry-author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><a href="https://keybase.io/onnimonni" title="Posts by Onni Hakala" rel="author" class="url fn n" itemprop="url"> <amp-img itemprop="image" class="img-circle meta-author-image" width="40" height="40" alt="Onni Hakala" src="https://s.gravatar.com/avatar/ffbe81bf9fa424901ddc06be226c98a4"></amp-img> <span itemprop="name">Onni Hakala</span></a></span> on <time class="entry-published updated" datetime="2016-12-14T00:00:00+0000" itemprop="datePublished" title="Wednesday, December 14, 2016">December 14, 2016</time><span class="visually-hidden-mobile">.</span><p class="description"> <span class="visually-hidden-mobile">This article is</span> about <span itemprop="keywords"> <strong>travis</strong>, <strong>jekyll</strong> and <strong>bug</strong>. </span></p></div><p>Travis might break your <a href="https://www.ampproject.org/">amp pages</a> when you’re using <code class="highlighter-rouge">NOKOGIRI_USE_SYSTEM_LIBRARIES: true</code>.</p><p>Do you know the feeling when you have a bug which is just motherf* hard son of a bitch level bug to track. You spend hours or even days figuring it out persistantly closing different options out of the bigger picture. This just happened to me as well.</p><p><a href="https://search.google.com/search-console/amp">Google AMP validator</a> just outputted multiple errors even though my local development environment was just fine:</p><div class="highlighter-rouge"> <pre class="highlight"><code>The tag 'script' is disallowed except in specific forms.
The mandatory tag 'amphtml engine v0.js script' is missing or incorrect. (see
</code></pre></div><h2 id="the-context">The context</h2><p>I’m building and testing this site in <a href="https://travis-ci.org/KeksiLabs/keksi.io">Travis CI</a>. I had enabled <code class="highlighter-rouge">NOKOGIRI_USE_SYSTEM_LIBRARIES: true</code> in my <code class="highlighter-rouge">.travis.yml</code> because many developers have had good experience with that in order to speed up the builds.</p><p>Somehow the older version of nokogiri outputted the closing elements for my html head <code class="highlighter-rouge">&lt;/head&gt;&lt;body&gt;</code> too early.</p><p><strong>This was what I wanted to achieve:</strong></p><div class="language-html highlighter-rouge"> <pre class="highlight"><code><span class="nt">&lt;noscript&gt;&lt;style </span><span class="na">amp-boilerplate</span><span class="nt">&gt;body</span><span class="p">{</span><span class="nl">-webkit-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">-moz-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">-ms-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">animation</span><span class="p">:</span><span class="nb">none</span><span class="p">}</span><span class="nt">&lt;/style&gt;&lt;/noscript&gt;</span> <span class="nt">&lt;script </span><span class="na">async</span> <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0.js"</span><span class="nt">&gt;&lt;/script&gt;&lt;script </span><span class="na">async</span> <span class="na">custom-element=</span><span class="s">"amp-analytics"</span> <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0/amp-analytics-0.1.js"</span><span class="nt">&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;</span>
</code></pre></div><p><strong>This was what happened in the build phase instead:</strong></p><div class="language-html highlighter-rouge"> <pre class="highlight"><code><span class="nt">&lt;/head&gt;&lt;body&gt;</span> <span class="nt">&lt;noscript&gt;&lt;style </span><span class="na">amp-boilerplate</span><span class="nt">&gt;body</span><span class="p">{</span><span class="nl">-webkit-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">-moz-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">-ms-animation</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">animation</span><span class="p">:</span><span class="nb">none</span><span class="p">}</span><span class="nt">&lt;/style&gt;&lt;/noscript&gt;</span> <span class="nt">&lt;script </span><span class="na">async</span> <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0.js"</span><span class="nt">&gt;&lt;/script&gt;&lt;script </span><span class="na">async</span> <span class="na">custom-element=</span><span class="s">"amp-analytics"</span> <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0/amp-analytics-0.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div><p>As you can see the head element ends too soon.</p><h2 id="conclusion">Conclusion</h2><p>In the end it was super relieving after I figured this out. If you’re having random html errors try to disable notorius <code class="highlighter-rouge">NOKOGIRI_USE_SYSTEM_LIBRARIES</code>.</p></article> <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "BlogPosting",

    "headline": "Using NOKOGIRI_USE_SYSTEM_LIBRARIES in Travis CI breaks amp pages",
    
    "image":  {
        "@type": "ImageObject",
        "url": "https://keksi.io/tech/TravisCI-Full-Color-45e242791b7752b745a7ae53f265acd4.png",
        "caption": "Travis CI",
        "height": "201",
        "width": "642"
    },
    
    
    "genre": "Continuous Integration",
    
    "keywords": "travis,jekyll,bug",
    "wordcount": "215",
    "publisher": {
        "@type": "Organization",
        "logo": {
            "@type": "ImageObject",
            "url": "https://keksi.io/logo.png",
            "width": "512",
            "height": "512"
        },
        "email": "hello@keksi.io",
        "name": "Keksi Labs Oy",
        "sameAs": [
            "https://twitter.com/keksiengineer",
            "https://github.com/KeksiLabs"
        ]
    },
    "url": "https://keksi.io/amp/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html/",
    "mainEntityOfPage": "https://keksi.io/amp/gotcha/2016/12/14/using-nokogiriusesystemlibraries-in-travis-breaks-amp-pages-html/",
    "datePublished": "2016-12-14",
    "dateCreated": "2016-12-14",
    "dateModified": "2016-12-14",
    "description": "Full speed ahead in Web engineering
",
    "articleBody": "Travis might break your [amp pages](https://www.ampproject.org/) when you're using `NOKOGIRI_USE_SYSTEM_LIBRARIES: true`.Do you know the feeling when you have a bug which is just motherf* hard son of a bitch level bug to track. You spend hours or even days figuring it out persistantly closing different options out of the bigger picture. This just happened to me as well.[Google AMP validator](https://search.google.com/search-console/amp) just outputted multiple errors even though my local development environment was just fine:```The tag 'script' is disallowed except in specific forms.The mandatory tag 'amphtml engine v0.js script' is missing or incorrect. (see```## The contextI'm building and testing this site in [Travis CI](https://travis-ci.org/KeksiLabs/keksi.io). I had enabled `NOKOGIRI_USE_SYSTEM_LIBRARIES: true` in my `.travis.yml` because many developers have had good experience with that in order to speed up the builds.Somehow the older version of nokogiri outputted the closing elements for my html head `` too early.**This was what I wanted to achieve:**```html ```**This was what happened in the build phase instead:**```html  ```As you can see the head element ends too soon.## ConclusionIn the end it was super relieving after I figured this out. If you're having random html errors try to disable notorius `NOKOGIRI_USE_SYSTEM_LIBRARIES`.",
    "author": {
        "@type": "Person",
        "name": "Onni Hakala",
        "url": "https://keybase.io/onnimonni",
        "image": "https://s.gravatar.com/avatar/ffbe81bf9fa424901ddc06be226c98a4",
        
        "sameAs": [
            
            "https://twitter.com/koodimonni",
            
            
            "https://www.facebook.com/monnionni",
            
            
            "https://keybase.io/onnimonni",
            
            "https://github.com/onnimonni"
        ]
        
    }
}
</script><footer class="site-footer container"><div class="row"><div class="column"><div id="contact" class="footer-content vcard" itemscope itemtype="http://schema.org/Organization"><h1>Contact Us</h1><div><a class="url fn" itemprop="name" href="https://keksi.io/">Keksi Labs Oy</a></div><div><span itemprop="taxID">2734524-4</span></div> <a class="email" itemprop="email" href="mailto:hello@keksi.io">hello@keksi.io</a><div itemprop="address" itemscope itemtype="http://schema.org/PostalAddress" class="adr"> <span itemprop="addressLocality" class="locality">Tampere</span>, <span itemprop="addressCountry" class="country-name">Finland</span></div></div></div><div class="column"><div class="footer-content"><h1>What we do?</h1><p>Keksi is web solutions agency which uses latest open source tools to provide scalable web platforms. We believe in <strong>testing</strong>, <strong>monitoring</strong> and <strong>automation</strong>.</p><p>Because nobody wants to lose their good night's sleep worrying about crashing servers.</p><p></p></div></div></div><div class="notice"> <small>© Keksi Labs Oy</small>, <small>Disclaimer: We’re using cookies, because cookies are the best! Have one here: <amp-img class="avatar" src="/logo.svg" width="22" height="22" alt="Keksi Labs Logo" layout="fixed"> </amp-img></small></div> </footer><amp-analytics type="googleanalytics"> <script type="application/json">
{
  "vars": {
    "account": "UA-88238366-1"
  },
  "triggers": {
    "trackPageview": {
      "on": "visible",
      "request": "pageview"
    }
  }
}
</script></amp-analytics></body></html>