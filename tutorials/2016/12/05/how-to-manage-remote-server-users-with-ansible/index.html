<!DOCTYPE html><html class="no-js" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8" lang="en"><title>How to manage remote server users with ansible | Keksi.io</title><meta name="description" content="This post shows an powerful example of how to do user access management for admin/developer user accounts for medium to big sized web agencies. Managing user...
"><meta name="viewport" content="width=device-width, initial-scale=1"><meta property="og:title" content="How to manage remote server users with ansible"/><meta property="og:image" content="https://keksi.io/img/keksi-labs-og-small.png"/><meta name="twitter:image:alt" content="Keksi.io logo"/><meta property="og:image:width" content="300"/><meta property="og:image:height" content="300"/><meta name="twitter:site" content="keksiengineer"/><meta name="twitter:creator" content="koodimonni"/><meta property="article:published_time" content="2016-12-05T00:00:00+00:00"><meta property="article:modified_time" content="2017-01-10T09:22:02+00:00"><meta property="article:author" content="monnionni"><meta property="article:section" content="tutorials"><meta property="article:tag" content="ansible,devops,servers"><meta property="og:type" content="article"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://keksi.io/tech/Ansible-Mark-Small-RGB-Mango.png"/><meta name="twitter:image:alt" content="Ansible"/><meta property="og:description" content="This post shows an powerful example of how to do user access management for admin/developer user accounts for medium to big sized web agencies. Managing user...
"/><meta property="og:url" content="https://keksi.io/tutorials/2016/12/05/how-to-manage-remote-server-users-with-ansible/"/><meta property="og:locale" content="en_US"/><link rel="amphtml" href="https://keksi.io/amp/tutorials/2016/12/05/how-to-manage-remote-server-users-with-ansible"><link type="text/css" rel="stylesheet" href="/assets/main-72b7720bf5f8884ff8539861c403b9c3bb2875391497ce90242d913ffc31f7ad.css"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="canonical" href="https://keksi.io/tutorials/2016/12/05/how-to-manage-remote-server-users-with-ansible/"><link rel="alternate" type="application/atom+xml" title="Keksi.io" href="https://keksi.io/feed.xml"/> <script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-88238366-1","auto"),ga("send","pageview")</script></head><body> <header class="site-header"><div class="branding"> <a href="/"> <picture><source type="image/svg+xml" srcset="/logo.svg"><img class="avatar" src="/logo-44x44.png" width="44" alt="Keksi Labs Logo" height="44"></picture><h1 class="site-title">Keksi.io</h1> </a></div> <nav class="site-nav"><ul><li> <a class="page-link" href="/about/"> About </a></li></ul> </nav><nav class="external-links"><ul><li> <a href="https://keksi.io/feed.xml" title="Follow RSS feed"> <i class="fa fa-fw fa-rss"></i> </a></li><li> <a href="mailto:hello@keksi.io" title="Email"> <i class="fa fa-fw fa-envelope"></i> </a></li><li> <a href="https://github.com/KeksiLabs" title="Follow on GitHub"> <i class="fa fa-fw fa-github"></i> </a></li><li> <a href="https://twitter.com/keksiengineer" title="Follow on Twitter"> <i class="fa fa-fw fa-twitter"></i> </a></li></ul> </nav> </header><div class="content"> <article itemscope="itemscope" itemtype="http://schema.org/BlogPosting" itemprop="blogPost"> <header style="background-image:url('/')"><h1 itemprop="headline" class="title">How to manage remote server users with ansible</h1><div class="post-about"> <span class="visually-hidden-mobile">Written by</span> <span class="entry-author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><a href="https://keybase.io/onnimonni" title="Posts by Onni Hakala" rel="author" class="url fn n" itemprop="url"> <img itemprop="image" class="img-circle meta-author-image" width="40" height="40" alt="Onni Hakala" src="https://s.gravatar.com/avatar/ffbe81bf9fa424901ddc06be226c98a4"> <span itemprop="name">Onni Hakala</span></a></span> on <time class="entry-published updated" datetime="2016-12-05T00:00:00+0000" itemprop="datePublished" title="Monday, December  5, 2016">December 5, 2016</time><span class="visually-hidden-mobile">.</span><p class="description"> <span class="visually-hidden-mobile">This article is</span> about <span itemprop="keywords"> <strong>ansible</strong>, <strong>devops</strong> and <strong>servers</strong>. </span></p></div> </header><section itemprop="articleBody" class="post-content"><p>This post shows an powerful example of how to do user access management for admin/developer user accounts for medium to big sized web agencies. Managing users efficiently and securely in big company usually includes a clunky process like LDAP. Today I will show you how to use git and ansible instead.</p><h2 id="introduction">Introduction</h2><p>When companies grow and start to have tens or hundreds of servers it starts to take enormous amount of time to create users into the servers manually. Many web agencies just get tired and allow <code class="highlighter-rouge">root</code> user access for all of their administrators/developers.</p><p>This is a bad practise which should be always avoided because it makes auditing so much harder. What about if a person leaves the company or their laptop and private ssh keys get stolen? Then you would need to revoke the access ASAP and this will be harder if the company doesn’t keep record of all of their users and their access levels.</p><p>Many developers also won’t understand how dangerous it is to paste the same root user passwords in plaintext in sms, email or company chat like slack. It’s quite easy to gain access to any of those medias.</p><h2 id="ansible-and-ssh-keys-to-the-rescue">Ansible and ssh keys to the rescue</h2><p>We in Keksi Labs have helped multiple smaller companies to manage this problem with configuration management.</p><p>The solution is to keep record of all of the granted users in git and use ansible to deploy all of the changes.</p><p>This is passwordless solution for remote server access with ssh.</p><p>If you want to see full real world example look into our github:</p><p><a href="https://github.com/KeksiLabs/ansible-user-management-example">KeksiLabs/ansible-user-management-example</a>.</p><h3 id="tutorial-for-ansible-and-git">Tutorial for ansible and git</h3><p>Here’s quick example for how to do this with ansible. More advanced users should see the provided repository mentioned earlier.</p><h3 id="step-1-create-a-project">Step 1. Create a project</h3><div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">mkdir</span><span class="kv"> user-management-ansible
</span><span class="w">$ </span><span class="nc">cd</span><span class="kv"> user-management-ansible
</span><span class="w">$ </span><span class="nc">git</span><span class="kv"> init .
</span></code></pre></div><h3 id="step-2-copy-example-ansible-into-your-project">Step 2: Copy example ansible into your project</h3><p>Copy this provided <code class="highlighter-rouge">yml</code> ansbile config into file named <code class="highlighter-rouge">users.yml</code>.</p><p>Let’s see what this does:</p><ul><li>It creates new group called <code class="highlighter-rouge">infra_admin</code> and gives it sudo privileges.</li><li>It checks that provided users exist in the target machines with their ssh keys</li><li>It deletes users which should be absent</li></ul><div class="language-yml highlighter-rouge"><pre class="highlight"><code><span class="c1">##</span>
<span class="c1"># This ansible playbook handles and creates all provided users from</span>
<span class="c1"># company_admin_list</span>
<span class="c1">#</span>
<span class="c1"># For more advanced but similiar setup see: https://github.com/KeksiLabs/ansible-user-management-example</span>
<span class="c1">##</span>
<span class="nn">---</span>
<span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">Install all users</span>
  <span class="s">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="s">become</span><span class="pi">:</span> <span class="s">true</span>
  <span class="s">vars</span><span class="pi">:</span>
    <span class="s">admin_group</span><span class="pi">:</span> <span class="s1">'</span><span class="s">infra_admin'</span>
    <span class="s">company_admin_list</span><span class="pi">:</span>
      <span class="c1"># This is how add users to servers</span>
      <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Onni</span><span class="nv"> </span><span class="s">Hakala"</span>
        <span class="s">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">onnimonni"</span>
        <span class="s">keys</span><span class="pi">:</span>
          <span class="s">active</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">ssh-rsa</span><span class="nv"> </span><span class="s">AAAAB3NzaC1yc2EAAAADAQABAAABgQC8gOdvYe12yaVQGMZXgn0qcd7vxMZhj1wsBTDFP/HnwdnbywbV/jt//yGex51cTkfqoP3YlkdgUfQeKJws4j7rxu04gx6uRBIlRcR+7wdcFgksFs4EFumTpZOSOwKybHVIbeIubLi76+mhB9L2JXD4f+TtkL0WJtvBDsCavGLHbru2JafS3K/6b97sU2vpmA/mDREKDpnuVxcMXsXlY0THgoxx70L7SjYsWMzRYiJc+FWzMqyi1yribhEUuUT4ch6B7DiBuPfWFQUlA2KkGbihsw+Kmyrw0e36z1MOEWAhroczt8zKjawWeYQ4qTwQRrjM8b+C2yfFgBpUqFAhAM0Lb9dh8V3xfui30zik2eW2LTQ4JtD2xNUflA+NvG2+fcB7w3ub+QNXI3zp+Joto627oB3j4Nao+s/XHOd0T8idHVrbfhoRK8UE4r6nKI8b5b7JrzaDipE1CjS2TsIixaj9a/VxYMtNE2A9JPGHsXlIPpi++GaW+rz4DZoqkArfsFE=</span><span class="nv"> </span><span class="s">onni@keksi.io"</span>
          <span class="s">disabled</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">ssh-rsa</span><span class="nv"> </span><span class="s">AAAAB3NzaC1yc2EAAAADAQABAAABAQCsPoDM21LjBodcS3Kiq7ZDyNjFY4L03Yx2nSoSzdV7TKj00Zk8gh1hSSgI/xSDXiK+QEbfPuh/7+G3sfeDDNavjWUA1kdLve4D6MTI302C3HilK6wOZV67ezyAgdgf/VCHfx+no+bocw/05r1VamLrnFjDasWAQFFeFLaOnfQTArHQRl2Z8+4ZtZ1YQPhnleFQfEz546D3oWE1DS3vuXL1Qodz3gijtHhGnc3jaQM+7m/gg2vrcL6bc/vCtdunpA1fSQrBSx0kK4qdTWwc2LZDwKIT3YP5GthvgkFHsbCo2mNdBwWZfOBTYr5LBpz9YBcO7oVBWVEI00BdEPRFOYJL</span><span class="nv"> </span><span class="s">onnimonni@Onni-MacBook-Air.local"</span>
        <span class="s">shell</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/bin/bash"</span>
        <span class="s">state</span><span class="pi">:</span> <span class="s">present</span>
      <span class="c1"># This is how you remove users</span>
      <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Example</span><span class="nv"> </span><span class="s">Quitted</span><span class="nv"> </span><span class="s">Person"</span>
        <span class="s">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">example-quitted-person"</span>
        <span class="s">state</span><span class="pi">:</span> <span class="s">absent</span>

  <span class="s">tasks</span><span class="pi">:</span>

  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">Setup all users</span>
    <span class="s">user</span><span class="pi">:</span>
      <span class="s">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.username</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="s">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.state</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default('present')</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="s">shell</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.shell</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default('/bin/bash')</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="s">group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">admin_group</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="s">remove</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="s">when</span><span class="pi">:</span> <span class="s">item.username is defined</span>
    <span class="s">with_items</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">full_admin_list</span><span class="nv"> </span><span class="s">}}"</span>

  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">Add SSH-keys to users</span>
    <span class="s">authorized_key</span><span class="pi">:</span>
      <span class="s">user</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.0.username</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="s">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.1</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="s">with_subelements</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">full_admin_list</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="pi">-</span> <span class="s">keys.active</span>
      <span class="pi">-</span> <span class="s">flags</span><span class="pi">:</span>
        <span class="s">skip_missing</span><span class="pi">:</span> <span class="s">True</span>
    <span class="s">when</span><span class="pi">:</span> <span class="s">item.0.state != "absent"</span>

  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">Remove old SSH-keys from users</span>
    <span class="s">authorized_key</span><span class="pi">:</span>
      <span class="s">user</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.0.username</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="s">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.1</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="s">state</span><span class="pi">:</span> <span class="s">absent</span>
    <span class="s">with_subelements</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">full_admin_list</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="pi">-</span> <span class="s">keys.disabled</span>
      <span class="pi">-</span> <span class="s">flags</span><span class="pi">:</span>
        <span class="s">skip_missing</span><span class="pi">:</span> <span class="s">True</span>
    <span class="s">when</span><span class="pi">:</span> <span class="s">item.0.state != "absent"</span>

  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">Add admin group to sudoers</span>
    <span class="s">lineinfile</span><span class="pi">:</span> <span class="s">dest=/etc/sudoers regexp="^%{{ admin_group }}" line="%{{ admin_group }} ALL=(ALL) NOPASSWD:ALL"</span>

  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">Disable Requiretty from sudoers</span>
    <span class="s">lineinfile</span><span class="pi">:</span> <span class="s">dest=/etc/sudoers regexp="Defaults    requiretty" line="#Defaults    requiretty"</span>
</code></pre></div><h3 id="step-3-add-your-users">Step 3: Add your users</h3><p>Edit this section from the provided example and add your username and ssh keys. You don’t have to have any disabled keys when you start.</p><div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">company_admin_list</span><span class="pi">:</span>
  <span class="c1"># This is how add users to servers</span>
  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Onni</span><span class="nv"> </span><span class="s">Hakala"</span>
    <span class="s">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">onnimonni"</span>
    <span class="s">keys</span><span class="pi">:</span>
      <span class="s">active</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">ssh-rsa</span><span class="nv"> </span><span class="s">AAAAB3NzaC1yc2EAAAADAQABAAABgQC8gOdvYe12yaVQGMZXgn0qcd7vxMZhj1wsBTDFP/HnwdnbywbV/jt//yGex51cTkfqoP3YlkdgUfQeKJws4j7rxu04gx6uRBIlRcR+7wdcFgksFs4EFumTpZOSOwKybHVIbeIubLi76+mhB9L2JXD4f+TtkL0WJtvBDsCavGLHbru2JafS3K/6b97sU2vpmA/mDREKDpnuVxcMXsXlY0THgoxx70L7SjYsWMzRYiJc+FWzMqyi1yribhEUuUT4ch6B7DiBuPfWFQUlA2KkGbihsw+Kmyrw0e36z1MOEWAhroczt8zKjawWeYQ4qTwQRrjM8b+C2yfFgBpUqFAhAM0Lb9dh8V3xfui30zik2eW2LTQ4JtD2xNUflA+NvG2+fcB7w3ub+QNXI3zp+Joto627oB3j4Nao+s/XHOd0T8idHVrbfhoRK8UE4r6nKI8b5b7JrzaDipE1CjS2TsIixaj9a/VxYMtNE2A9JPGHsXlIPpi++GaW+rz4DZoqkArfsFE=</span><span class="nv"> </span><span class="s">onni@keksi.io"</span>
      <span class="s">disabled</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">ssh-rsa</span><span class="nv"> </span><span class="s">AAAAB3NzaC1yc2EAAAADAQABAAABAQCsPoDM21LjBodcS3Kiq7ZDyNjFY4L03Yx2nSoSzdV7TKj00Zk8gh1hSSgI/xSDXiK+QEbfPuh/7+G3sfeDDNavjWUA1kdLve4D6MTI302C3HilK6wOZV67ezyAgdgf/VCHfx+no+bocw/05r1VamLrnFjDasWAQFFeFLaOnfQTArHQRl2Z8+4ZtZ1YQPhnleFQfEz546D3oWE1DS3vuXL1Qodz3gijtHhGnc3jaQM+7m/gg2vrcL6bc/vCtdunpA1fSQrBSx0kK4qdTWwc2LZDwKIT3YP5GthvgkFHsbCo2mNdBwWZfOBTYr5LBpz9YBcO7oVBWVEI00BdEPRFOYJL</span><span class="nv"> </span><span class="s">onnimonni@Onni-MacBook-Air.local"</span>
    <span class="s">shell</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/bin/bash"</span>
    <span class="s">state</span><span class="pi">:</span> <span class="s">present</span>
  <span class="c1"># This is how you remove users</span>
  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Example</span><span class="nv"> </span><span class="s">Quitted</span><span class="nv"> </span><span class="s">Person"</span>
    <span class="s">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">example-quitted-person"</span>
    <span class="s">state</span><span class="pi">:</span> <span class="s">absent</span>
</code></pre></div><h3 id="step-4-add-your-servers">Step 4: Add your servers</h3><p>Create file called <code class="highlighter-rouge">inventory</code> with your servers in it:</p><p>Remember to use real IP addresses or hostnames instead of <code class="highlighter-rouge">xxx.xxx.xxx.xxx</code> or <code class="highlighter-rouge">yyy.yyy.yyy.yyy</code>.</p><div class="highlighter-rouge"><pre class="highlight"><code>[servers]
xxx.xxx.xxx.xxx ansible_port=22
yyy.yyy.yyy.yyy ansible_port=22
</code></pre></div><p>You can use a custom ssh port by providing <code class="highlighter-rouge">ansible_port</code> variable.</p><h3 id="step-5-install-ansible">Step 5: Install ansible</h3><p>For OSX ansible can be installed with homebrew:</p><div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">brew</span><span class="kv"> install ansible
</span></code></pre></div><p>Usually you want to use pip because it provides better version handling:</p><div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">pip</span><span class="kv"> install ansible
</span></code></pre></div><h3 id="step-6-deploy-your-users">Step 6: Deploy your users</h3><p>You can use any user which is already setupped in the servers. When starting with the new servers it’s usually <code class="highlighter-rouge">root</code>.</p><p>This deploys all provided users with ansible:</p><div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">ansible-playbook</span><span class="kv"> -i inventory users.yml -u root --ask-pass
</span></code></pre></div><h3 id="step-7-test-ssh-login">Step 7: Test ssh login</h3><p>Now try to login with the users that you created. Everything should just work.</p><h3 id="step-8-store-your-changes-in-git">Step 8: Store your changes in git</h3><p>Now commit all your changes:</p><div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">git</span><span class="kv"> add --all
</span><span class="w">$ </span><span class="nc">git</span><span class="kv"> commit -am "Initial user setup"
</span></code></pre></div><h3 id="step-9-push-these-configs-in-private-git-repository">Step 9: Push these configs in private git repository</h3><p>It’s usually a good idea to share this setup with your workmates.</p><p>We recommend Github, Gitlab and Bitbucket. This repository doesn’t contain anything sensitive like plaintext passwords so It’s okay to put it into 3rd party version control.</p><h2 id="congratulations">Congratulations</h2><p>You are now managing all of your users with ansible. When you need to have more users just add them into the users array and deploy again. Remember to share your changes with your coworkers and teach them how to use this setup.</p><p>If you want to learn more you should head into our example repo: <a href="https://github.com/KeksiLabs/ansible-user-management-example">KeksiLabs/ansible-user-management-example</a>.</p></section><small class="footnotes"> <i class="fa fa-info-circle"></i> <strong>Info:</strong> This post was last updated on: <time class="entry-modified modified" datetime="2017-01-10T09:22:02+0000" itemprop="dateModified" title="Tuesday, January 10, 2017">January 10, 2017</time>. It is published in <span itemprop="articleSection">tutorials</span> category, contains <span itemprop="wordCount">913</span> words and takes about <span>6</span> minutes to read.<meta itemprop="timeRequired" content="P6"/><meta itemprop="image" content="https://keksi.io/tech/Ansible-Mark-Small-RGB-Mango.png"/><meta itemprop="mainEntityOfPage" content="https://keksi.io/tutorials/2016/12/05/how-to-manage-remote-server-users-with-ansible/"/> <span> It was published by <span itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"> <span itemprop="logo" itemscope itemtype="https://schema.org/ImageObject"><link itemprop="url" href="https://keksi.io/logo.png"/><meta itemprop="width" content="512"><meta itemprop="height" content="512"> </span><meta itemprop="email" content="hello@keksi.io"> <span itemprop="name">Keksi Labs Oy</span>. </span> </span> </small></article><div class="comments"><h2>Comments:</h2> <a class="muut" href="https://muut.com/i/keksi/comments" type="dynamic">keksi</a> <script async src="//cdn.muut.com/1/moot.min.js"></script></div></div> <footer class="site-footer container"><div class="row"><div class="column"><div id="contact" class="footer-content vcard" itemscope itemtype="http://schema.org/Organization"><h1>Contact Us</h1><div><a class="url fn" itemprop="name" href="https://keksi.io/">Keksi Labs Oy</a></div><div><span itemprop="taxID">2734524-4</span></div> <a class="email" itemprop="email" href="mailto:hello@keksi.io">hello@keksi.io</a><div itemprop="address" itemscope itemtype="http://schema.org/PostalAddress" class="adr"> <span itemprop="addressLocality" class="locality">Tampere</span>, <span itemprop="addressCountry" class="country-name">Finland</span></div></div></div><div class="column"><div class="footer-content"><h1>What we do?</h1><p>Keksi is web solutions agency which uses latest open source tools to provide scalable web platforms. We believe in <strong>testing</strong>, <strong>monitoring</strong> and <strong>automation</strong>.</p><p>Because nobody wants to lose their good night's sleep worrying about crashing servers.</p><p></div></div></div><div class="notice"> <small>© Keksi Labs Oy</small>, <small>Disclaimer: We’re using cookies, because cookies are the best! Have one here: <picture><source type="image/svg+xml" srcset="/logo.svg"><img class="avatar" src="/logo-22x22.png" width="22" alt="Keksi Labs Logo" height="22"></picture></small></div> </footer><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "BlogPosting",

    "headline": "How to manage remote server users with ansible",
    
    "image":  {
        "@type": "ImageObject",
        "url": "https://keksi.io/tech/Ansible-Mark-Small-RGB-Mango.png",
        "caption": "Ansible",
        "height": "300",
        "width": "300"
    },
    
    
    "keywords": "ansible,devops,servers",
    "wordcount": "913",
    "publisher": {
        "@type": "Organization",
        "logo": {
            "@type": "ImageObject",
            "url": "https://keksi.io/logo.png",
            "width": "512",
            "height": "512"
        },
        "email": "hello@keksi.io",
        "name": "Keksi Labs Oy",
        "sameAs": [
            "https://twitter.com/keksiengineer",
            "https://github.com/KeksiLabs"
        ]
    },
    "url": "https://keksi.io/tutorials/2016/12/05/how-to-manage-remote-server-users-with-ansible/",
    "mainEntityOfPage": "https://keksi.io/tutorials/2016/12/05/how-to-manage-remote-server-users-with-ansible/",
    "datePublished": "2016-12-05",
    "dateCreated": "2016-12-05",
    "dateModified": "2017-01-10",
    "description": "This post shows an powerful example of how to do user access management for admin/developer user accounts for medium to big sized web agencies. Managing user...
",
    "articleBody": "This post shows an powerful example of how to do user access management for admin/developer user accounts for medium to big sized web agencies. Managing users efficiently and securely in big company usually includes a clunky process like LDAP. Today I will show you how to use git and ansible instead.IntroductionWhen companies grow and start to have tens or hundreds of servers it starts to take enormous amount of time to create users into the servers manually. Many web agencies just get tired and allow root user access for all of their administrators/developers.This is a bad practise which should be always avoided because it makes auditing so much harder. What about if a person leaves the company or their laptop and private ssh keys get stolen? Then you would need to revoke the access ASAP and this will be harder if the company doesn’t keep record of all of their users and their access levels.Many developers also won’t understand how dangerous it is to paste the same root user passwords in plaintext in sms, email or company chat like slack. It’s quite easy to gain access to any of those medias.Ansible and ssh keys to the rescueWe in Keksi Labs have helped multiple smaller companies to manage this problem with configuration management.The solution is to keep record of all of the granted users in git and use ansible to deploy all of the changes.This is passwordless solution for remote server access with ssh.If you want to see full real world example look into our github:KeksiLabs/ansible-user-management-example.Tutorial for ansible and gitHere’s quick example for how to do this with ansible. More advanced users should see the provided repository mentioned earlier.Step 1. Create a project$ mkdir user-management-ansible$ cd user-management-ansible$ git init .Step 2: Copy example ansible into your projectCopy this provided yml ansbile config into file named users.yml.Let’s see what this does:  It creates new group called infra_admin and gives it sudo privileges.  It checks that provided users exist in the target machines with their ssh keys  It deletes users which should be absent### This ansible playbook handles and creates all provided users from# company_admin_list## For more advanced but similiar setup see: https://github.com/KeksiLabs/ansible-user-management-example##---- name: Install all users  hosts: all  become: true  vars:    admin_group: 'infra_admin'    company_admin_list:      # This is how add users to servers      - name: \"Onni Hakala\"        username: \"onnimonni\"        keys:          active:            - \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC8gOdvYe12yaVQGMZXgn0qcd7vxMZhj1wsBTDFP/HnwdnbywbV/jt//yGex51cTkfqoP3YlkdgUfQeKJws4j7rxu04gx6uRBIlRcR+7wdcFgksFs4EFumTpZOSOwKybHVIbeIubLi76+mhB9L2JXD4f+TtkL0WJtvBDsCavGLHbru2JafS3K/6b97sU2vpmA/mDREKDpnuVxcMXsXlY0THgoxx70L7SjYsWMzRYiJc+FWzMqyi1yribhEUuUT4ch6B7DiBuPfWFQUlA2KkGbihsw+Kmyrw0e36z1MOEWAhroczt8zKjawWeYQ4qTwQRrjM8b+C2yfFgBpUqFAhAM0Lb9dh8V3xfui30zik2eW2LTQ4JtD2xNUflA+NvG2+fcB7w3ub+QNXI3zp+Joto627oB3j4Nao+s/XHOd0T8idHVrbfhoRK8UE4r6nKI8b5b7JrzaDipE1CjS2TsIixaj9a/VxYMtNE2A9JPGHsXlIPpi++GaW+rz4DZoqkArfsFE= onni@keksi.io\"          disabled:            - \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCsPoDM21LjBodcS3Kiq7ZDyNjFY4L03Yx2nSoSzdV7TKj00Zk8gh1hSSgI/xSDXiK+QEbfPuh/7+G3sfeDDNavjWUA1kdLve4D6MTI302C3HilK6wOZV67ezyAgdgf/VCHfx+no+bocw/05r1VamLrnFjDasWAQFFeFLaOnfQTArHQRl2Z8+4ZtZ1YQPhnleFQfEz546D3oWE1DS3vuXL1Qodz3gijtHhGnc3jaQM+7m/gg2vrcL6bc/vCtdunpA1fSQrBSx0kK4qdTWwc2LZDwKIT3YP5GthvgkFHsbCo2mNdBwWZfOBTYr5LBpz9YBcO7oVBWVEI00BdEPRFOYJL onnimonni@Onni-MacBook-Air.local\"        shell: \"/bin/bash\"        state: present      # This is how you remove users      - name: \"Example Quitted Person\"        username: \"example-quitted-person\"        state: absent  tasks:  - name: Setup all users    user:      name: \"{{ item.username }}\"      state: \"{{ item.state | default('present') }}\"      shell: \"{{ item.shell | default('/bin/bash') }}\"      group: \"{{ admin_group }}\"      remove: yes    when: item.username is defined    with_items:      - \"{{ full_admin_list }}\"  - name: Add SSH-keys to users    authorized_key:      user: \"{{ item.0.username }}\"      key: \"{{ item.1 }}\"    with_subelements:      - \"{{ full_admin_list }}\"      - keys.active      - flags:        skip_missing: True    when: item.0.state != \"absent\"  - name: Remove old SSH-keys from users    authorized_key:      user: \"{{ item.0.username }}\"      key: \"{{ item.1 }}\"      state: absent    with_subelements:      - \"{{ full_admin_list }}\"      - keys.disabled      - flags:        skip_missing: True    when: item.0.state != \"absent\"  - name: Add admin group to sudoers    lineinfile: dest=/etc/sudoers regexp=\"^%{{ admin_group }}\" line=\"%{{ admin_group }} ALL=(ALL) NOPASSWD:ALL\"  - name: Disable Requiretty from sudoers    lineinfile: dest=/etc/sudoers regexp=\"Defaults    requiretty\" line=\"#Defaults    requiretty\"Step 3: Add your usersEdit this section from the provided example and add your username and ssh keys. You don’t have to have any disabled keys when you start.company_admin_list:  # This is how add users to servers  - name: \"Onni Hakala\"    username: \"onnimonni\"    keys:      active:        - \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC8gOdvYe12yaVQGMZXgn0qcd7vxMZhj1wsBTDFP/HnwdnbywbV/jt//yGex51cTkfqoP3YlkdgUfQeKJws4j7rxu04gx6uRBIlRcR+7wdcFgksFs4EFumTpZOSOwKybHVIbeIubLi76+mhB9L2JXD4f+TtkL0WJtvBDsCavGLHbru2JafS3K/6b97sU2vpmA/mDREKDpnuVxcMXsXlY0THgoxx70L7SjYsWMzRYiJc+FWzMqyi1yribhEUuUT4ch6B7DiBuPfWFQUlA2KkGbihsw+Kmyrw0e36z1MOEWAhroczt8zKjawWeYQ4qTwQRrjM8b+C2yfFgBpUqFAhAM0Lb9dh8V3xfui30zik2eW2LTQ4JtD2xNUflA+NvG2+fcB7w3ub+QNXI3zp+Joto627oB3j4Nao+s/XHOd0T8idHVrbfhoRK8UE4r6nKI8b5b7JrzaDipE1CjS2TsIixaj9a/VxYMtNE2A9JPGHsXlIPpi++GaW+rz4DZoqkArfsFE= onni@keksi.io\"      disabled:        - \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCsPoDM21LjBodcS3Kiq7ZDyNjFY4L03Yx2nSoSzdV7TKj00Zk8gh1hSSgI/xSDXiK+QEbfPuh/7+G3sfeDDNavjWUA1kdLve4D6MTI302C3HilK6wOZV67ezyAgdgf/VCHfx+no+bocw/05r1VamLrnFjDasWAQFFeFLaOnfQTArHQRl2Z8+4ZtZ1YQPhnleFQfEz546D3oWE1DS3vuXL1Qodz3gijtHhGnc3jaQM+7m/gg2vrcL6bc/vCtdunpA1fSQrBSx0kK4qdTWwc2LZDwKIT3YP5GthvgkFHsbCo2mNdBwWZfOBTYr5LBpz9YBcO7oVBWVEI00BdEPRFOYJL onnimonni@Onni-MacBook-Air.local\"    shell: \"/bin/bash\"    state: present  # This is how you remove users  - name: \"Example Quitted Person\"    username: \"example-quitted-person\"    state: absentStep 4: Add your serversCreate file called inventory with your servers in it:Remember to use real IP addresses or hostnames instead of xxx.xxx.xxx.xxx or yyy.yyy.yyy.yyy.[servers]xxx.xxx.xxx.xxx ansible_port=22yyy.yyy.yyy.yyy ansible_port=22You can use a custom ssh port by providing ansible_port variable.Step 5: Install ansibleFor OSX ansible can be installed with homebrew:$ brew install ansibleUsually you want to use pip because it provides better version handling:$ pip install ansibleStep 6: Deploy your usersYou can use any user which is already setupped in the servers. When starting with the new servers it’s usually root.This deploys all provided users with ansible:$ ansible-playbook -i inventory users.yml -u root --ask-passStep 7: Test ssh loginNow try to login with the users that you created. Everything should just work.Step 8: Store your changes in gitNow commit all your changes:$ git add --all$ git commit -am \"Initial user setup\"Step 9: Push these configs in private git repositoryIt’s usually a good idea to share this setup with your workmates.We recommend Github, Gitlab and Bitbucket. This repository doesn’t contain anything sensitive like plaintext passwords so It’s okay to put it into 3rd party version control.CongratulationsYou are now managing all of your users with ansible. When you need to have more users just add them into the users array and deploy again. Remember to share your changes with your coworkers and teach them how to use this setup.If you want to learn more you should head into our example repo: KeksiLabs/ansible-user-management-example.",
    "author": {
        "@type": "Person",
        "name": "Onni Hakala",
        "url": "https://keybase.io/onnimonni",
        "image": "https://s.gravatar.com/avatar/ffbe81bf9fa424901ddc06be226c98a4",
        
        "sameAs": [
            
            "https://twitter.com/koodimonni",
            
            
            "https://www.facebook.com/monnionni",
            
            
            "https://keybase.io/onnimonni",
            
            "https://github.com/onnimonni"
        ]
        
    }
}
</script><script src="/assets/app-7e9774e4ca12ac9d274eefe9bb5bbcad25026046fbbfaddab8edf3cc83b7968c.js"></script></body></html>